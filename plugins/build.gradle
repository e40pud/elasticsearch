/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the "Elastic License
 * 2.0", the "GNU Affero General Public License v3.0 only", and the "Server Side
 * Public License v 1"; you may not use this file except in compliance with, at
 * your election, the "Elastic License 2.0", the "GNU Affero General Public
 * License v3.0 only", or the "Server Side Public License, v 1".
 */

configurations {
  allPlugins
}

def pluginDirs = [
  rootProject.file('plugins'), 
  rootProject.file('x-pack/plugin')
]

pluginDirs.each { dir ->
  if (dir.isDirectory()) {
    dir.listFiles()?.each { subDir ->
      if (subDir.isDirectory()) {
        def proj = rootProject.findProject(":${dir.name}:${subDir.name}")
        
        if (proj != null) { 
          proj.configure(proj) {
            group = 'org.elasticsearch.plugin'
            apply plugin: 'elasticsearch.internal-es-plugin'

            esplugin { 
              name = proj.name
              if (dir.name == 'x-pack') {
                 licenseFile = rootProject.layout.settingsDirectory.file('licenses/ELASTIC-LICENSE-2.0.txt').asFile
                 noticeFile = rootProject.file('x-pack/NOTICE.txt')
              } else {
                 licenseFile = rootProject.layout.settingsDirectory.file('licenses/AGPL-3.0+SSPL-1.0+ELASTIC-LICENSE-2.0.txt').asFile
                 noticeFile = rootProject.layout.settingsDirectory.file('NOTICE.txt').asFile
              }
            }
            
            rootProject.project(':plugins').artifacts.add('allPlugins', proj.tasks.named('bundlePlugin'))
          }
        }
      }
    }
  }
}
